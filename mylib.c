#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>


unsigned char *pfile;
unsigned char *outfile;
unsigned int tsize = 0;
unsigned int csize = 0;
unsigned int source_len;
unsigned int source_pos;
unsigned char p_len[64] = {
    0x03, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08
}; 

unsigned char p_code[64] = {
    0x00, 0x20, 0x30, 0x40, 0x50, 0x58, 0x60, 0x68,
    0x70, 0x78, 0x80, 0x88, 0x90, 0x94, 0x98, 0x9C,
    0xA0, 0xA4, 0xA8, 0xAC, 0xB0, 0xB4, 0xB8, 0xBC,
    0xC0, 0xC2, 0xC4, 0xC6, 0xC8, 0xCA, 0xCC, 0xCE,
    0xD0, 0xD2, 0xD4, 0xD6, 0xD8, 0xDA, 0xDC, 0xDE,
    0xE0, 0xE2, 0xE4, 0xE6, 0xE8, 0xEA, 0xEC, 0xEE,
    0xF0, 0xF1, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7,
    0xF8, 0xF9, 0xFA, 0xFB, 0xFC, 0xFD, 0xFE, 0xFF
};

/* decoder table */
unsigned char d_code[256] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
    0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09,
    0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A,
    0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B, 0x0B,
    0x0C, 0x0C, 0x0C, 0x0C, 0x0D, 0x0D, 0x0D, 0x0D,
    0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F, 0x0F,
    0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11,
    0x12, 0x12, 0x12, 0x12, 0x13, 0x13, 0x13, 0x13,
    0x14, 0x14, 0x14, 0x14, 0x15, 0x15, 0x15, 0x15,
    0x16, 0x16, 0x16, 0x16, 0x17, 0x17, 0x17, 0x17,
    0x18, 0x18, 0x19, 0x19, 0x1A, 0x1A, 0x1B, 0x1B,
    0x1C, 0x1C, 0x1D, 0x1D, 0x1E, 0x1E, 0x1F, 0x1F,
    0x20, 0x20, 0x21, 0x21, 0x22, 0x22, 0x23, 0x23,
    0x24, 0x24, 0x25, 0x25, 0x26, 0x26, 0x27, 0x27,
    0x28, 0x28, 0x29, 0x29, 0x2A, 0x2A, 0x2B, 0x2B,
    0x2C, 0x2C, 0x2D, 0x2D, 0x2E, 0x2E, 0x2F, 0x2F,
    0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
    0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
};

unsigned char d_len[256] = {
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
};
#define nx      4096
#define fn       60
#define TRD   	2
#define NIL     nx
unsigned char buf_out[nx + fn - 1];
signed short match_position, match_length;

signed short lson[nx + 1], rson[nx + 257], dad[nx + 1];
#define N_CHAR      (256 - TRD + fn)

#define T       (N_CHAR * 2 - 1)
#define R       (T - 1)
#define MAX_FREQ    0x8000
unsigned short freq[T + 1];
signed short prnt[T + N_CHAR];
signed short son[T];
unsigned short getbuf = 0;
unsigned char getlen = 0;
unsigned short putbuf = 0;
unsigned char putlen = 0;


void Init(void) {
    signed short i;

    for (i = nx + 1; i <= nx + 256; i++) rson[i] = NIL;
    for (i = 0; i < nx; i++) dad[i] = NIL;
}

void InNode(signed short r) {
    signed short i, p, cmp;
    unsigned char *key;
    unsigned short c;

    cmp = 1;
    key = &buf_out[r];
    p = nx + 1 + key[0];
    rson[r] = lson[r] = NIL;
    match_length = 0;
    for (;;) {
        if (cmp >= 0) {
            if (rson[p] != NIL) p = rson[p];
            else {
                rson[p] = r;
                dad[r] = p;
                return;
            }
        } else {
            if (lson[p] != NIL) p = lson[p];
            else {
                lson[p] = r;
                dad[r] = p;
                return;
            }
        }
        for (i = 1; i < fn; i++) if ((cmp = key[i] - buf_out[p + i]) != 0) break;
        if (i > TRD) {
            if (i > match_length) {
                match_position = ((r - p) & (nx - 1)) - 1;
                if ((match_length = i) >= fn) break;
            }
            if (i == match_length) {
                if ((c = ((r - p) & (nx - 1)) - 1) < match_position) {
                    match_position = c;
                }
            }
        }
    }
    dad[r] = dad[p];
    lson[r] = lson[p];
    rson[r] = rson[p];
    dad[lson[p]] = r;
    dad[rson[p]] = r;
    if (rson[dad[p]] == p) rson[dad[p]] = r;
    else lson[dad[p]] = r;
    dad[p] = NIL;
}

void DeNode(signed short p) {
    signed short q;

    if (dad[p] == NIL) return;
    if (rson[p] == NIL) q = lson[p];
    else if (lson[p] == NIL) q = rson[p];
    else {
        q = lson[p];
        if (rson[q] != NIL) {
            do {
                q = rson[q];
            } while (rson[q] != NIL);
            rson[dad[q]] = lson[q];
            dad[lson[q]] = dad[q];
            lson[q] = lson[p];
            dad[lson[p]] = q;
        }
        rson[q] = rson[p];
        dad[rson[p]] = q;
    }
    dad[q] = dad[p];
    if (rson[dad[p]] == p) rson[dad[p]] = q;
    else lson[dad[p]] = q;
    dad[p] = NIL;
}




signed short GetBit(void) {
    signed short i;

    while (getlen <= 8) {

        i = *pfile;
        if (source_pos >= source_len) i = 0;
        else {
            source_pos++;
            pfile++;
        }



        getbuf |= (i << (8 - getlen));
        getlen += 8;
    }
    i = getbuf;
    getbuf = getbuf << 1;
    getlen--;
    return(i < 0);
}

signed short GetByte(void) {
    signed short i;
    unsigned short ii;
    while (getlen <= 8) {

        i = *pfile;
        if (source_pos >= source_len) i = 0;
        else {
            source_pos++;
            pfile++;
        }

        getbuf |= (i << (8 - getlen));
        getlen += 8;
    }
    i = getbuf;
    getbuf = getbuf << 8;
    getlen -= 8;
    ii = (i >> 8) & 0x00ff;
    return(ii);
}



void Put_code(signed short l, unsigned short c) {
    putbuf |= c >> putlen;
    if ((putlen += l) >= 8) {

        *outfile = putbuf >> 8;
        outfile++;

        if ((putlen -= 8) >= 8) {

            *outfile = putbuf;
            outfile++;

            csize += 2;
            putlen -= 8;
            putbuf = c << (l - putlen);

        } else {
            putbuf <<= 8;
            csize++;
        }
    }
}




void StartExec() {
    signed short i, j;

    for (i = 0; i < N_CHAR; i++) {
        freq[i] = 1;
        son[i] = i + T;
        prnt[i + T] = i;
    }
    i = 0; j = N_CHAR;
    while (j <= R) {
        freq[j] = freq[i] + freq[i + 1];
        son[j] = i;
        prnt[i] = prnt[i + 1] = j;
        i += 2; j++;
    }
    freq[T] = 0xffff;
    prnt[R] = 0;
}




void reconst() {
    signed short i, j, k;
    unsigned short f, l;


    j = 0;
    for (i = 0; i < T; i++) {
        if (son[i] >= T) {
            freq[j] = (freq[i] + 1) / 2;
            son[j] = son[i];
            j++;
        }
    }

    for (i = 0, j = N_CHAR; j < T; i += 2, j++) {
        k = i + 1;
        f = freq[j] = freq[i] + freq[k];
        for (k = j - 1; f < freq[k]; k--) ;
        k++;
        l = (j - k) * 2;


        (void)memmove(&freq[k + 1], &freq[k], l);
        freq[k] = f;

        (void)memmove(&son[k + 1], &son[k], l);
        son[k] = i;
    }

    for (i = 0; i < T; i++) {
        if ((k = son[i]) >= T) {
            prnt[k] = i;
        } else {
            prnt[k] = prnt[k + 1] = i;
        }
    }
}




void update(signed short c) {
    signed short i, j, k, l;

    if (freq[R] == MAX_FREQ) {
        reconst();
    }
    c = prnt[c + T];
    do {
        k = ++freq[c];

        if (k > freq[l = c + 1]) {
            while (k > freq[++l]);
            l--;
            freq[c] = freq[l];
            freq[l] = k;

            i = son[c];
            prnt[i] = l;
            if (i < T) prnt[i + 1] = l;

            j = son[l];
            son[l] = i;

            prnt[j] = c;
            if (j < T) prnt[j + 1] = c;
            son[c] = j;

            c = l;
        }
    } while ((c = prnt[c]) != 0);
}

unsigned short code, len;

void EncodeChar(unsigned short c) {
    unsigned short i;
    signed short j, k;

    i = 0;
    j = 0;
    k = prnt[c + T];
    do {
        i >>= 1;
        if (k & 1) i += 0x8000;
        j++;
    } while ((k = prnt[k]) != R);
    Put_code(j, i);
    code = i;
    len = j;
    update(c);
}

void EncodePos(unsigned short c) {
    unsigned short i;


    i = c >> 6;
    Put_code(p_len[i], (unsigned)p_code[i] << 8);


    Put_code(6, (c & 0x3f) << 10);
}

void EncodeEnd() {
    if (putlen) {

        *outfile = putbuf >> 8;
        outfile++;

        csize++;
    }
}

signed short DecodeChar() {
    unsigned short c;

    c = son[R];


    while (c < T) {
        c += GetBit();
        c = son[c];
    }
    c -= T;
    update(c);
    return c;
}

signed short DecodePos() {
    unsigned short i, j, c;
    i = 0;
    i = GetByte();
    c = d_code[i] << 6;
    j = d_len[i];

    j -= 2;
    while (j--) {
        i = (i << 1) + GetBit();
    }
    return(c | i & 0x3f);
}
//unsigned short cbuf[2048];
//unsigned int kk,pp;
unsigned int Decrypt(unsigned char *in, unsigned int len, unsigned char *out) {
    signed short i, j, k, r, c, f;
    unsigned int count;
    tsize = 0;
    csize = 0;

    getbuf = 0;
    getlen = 0;
    putbuf = 0;
    putlen = 0;

    //memset(&cbuf[0],0,2048);
    pfile = in;
    tsize = *pfile;
    pfile++;
    tsize = tsize + (*pfile) * 256;
    pfile = in;
    pfile = in + 4;
    outfile = out;
    source_len = len;
    source_pos = 0;
    if (tsize == 0) return 0;
    StartExec();
    for (i = 0; i < nx - fn; i++) buf_out[i] = 0;
    r = nx - fn;
    for (count = 0; count < tsize;) {
        c = DecodeChar();
        //cbuf[kk]=c;
        //kk++;
        //if (kk>296)
        //	pp=90;
        if (c < 256) {

            *outfile = c;
            outfile++;

            buf_out[r++] = c;
            r &= (nx - 1);
            count++;
        } else {
            f = DecodePos();
            i = (r - f - 1) & (nx - 1);
            j = c - 255 + TRD;
            for (k = 0; k < j; k++) {
                c = buf_out[(i + k) & (nx - 1)];

                *outfile = c;
                outfile++;

                buf_out[r++] = c;
                r &= (nx - 1);
                count++;
            }
        }

    }
    return tsize;
}
